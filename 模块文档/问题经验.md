# 问题经验记录

## 2025-12-15：埋藏功能不生效

### 问题现象

用户点击"埋藏"按钮后，卡片的 `srs.due` 应该更新为明天，但重新打开复习面板后卡片仍然出现。

### 排查过程

1. **添加调试日志** → 确认 `buryCard` 的 `setProperties` 调用成功，`srs.due` 已写入为明天
2. **检查属性类型** → 发现 `type: "datetime"` 应改为 `type: 5`（数字标识符），但修复后问题仍存在
3. **分析缓存机制** → 发现 `storage.ts` 中的 `blockCache` 是问题根因

### 根因

- `storage.ts` 使用模块级 `blockCache` 缓存块数据以优化性能
- `buryCard` 在 `cardStatusUtils.ts` 中定义，无法访问 `storage.ts` 的缓存
- `collectReviewCards` 调用 `ensureCardSrsState` 时使用旧的缓存数据

### 解决方案

1. 在 `storage.ts` 中导出 `invalidateBlockCache(blockId)` 函数
2. 在 `buryCard` 中调用 `invalidateBlockCache(blockId)` 清除缓存

### 经验总结

- 跨模块修改数据时需注意缓存一致性
- 添加调试日志是定位问题的有效手段
- 属性写入成功 ≠ 后续读取使用最新值（可能被缓存）
