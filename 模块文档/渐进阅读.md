# 渐进阅读模块

## 功能概述

渐进阅读模块用于管理 Topic（主题）与 Extract（摘录）两类块的阅读节奏，提供独立于 SRS 复习的阅读面板与调度逻辑。支持优先级调度、原生编辑器、面包屑导航与完整操作（标记已读、跳过、调整优先级、生成卡片、删除）。

## 数据模型

渐进阅读状态存储在 Block Properties 中，字段如下：

- `ir.priority`：优先级，1-10（默认 5）
- `ir.lastRead`：上次阅读时间（Date 或 null）
- `ir.readCount`：累计阅读次数
- `ir.due`：下次到期时间（Date）

类型定义：

```ts
export type IRState = {
  priority: number
  lastRead: Date | null
  readCount: number
  due: Date
}
```

## 调度算法

优先级映射到固定的间隔天数：

- 10 → 1 天
- 8-9 → 2 天
- 6-7 → 3 天
- 4-5 → 5 天
- 1-3 → 7 天

核心函数：

```ts
getIntervalDays(priority)
calculateNextDue(priority, baseDate)
```

## API 参考

### `loadIRState(blockId)`
读取渐进阅读状态，缺失字段自动使用默认值。

### `saveIRState(blockId, state)`
写入 `ir.*` 属性。

### `ensureIRState(blockId)`
确保状态初始化（用于旧块自动补齐字段）。

### `markAsRead(blockId)`
标记已读，更新 `ir.lastRead`、`ir.readCount` 与 `ir.due`。

### `updatePriority(blockId, newPriority)`
更新优先级并立即重算 `ir.due`（基于当前时间）。

## 收集与队列

收集器只返回 `cardType` 为 `渐进阅读` 或 `extracts` 的块，并且满足以下条件之一：

- `ir.lastRead` 为空（新卡）
- `ir.due <= now`（到期卡）

队列构建采用 2:1 混合策略（到期卡:新卡），并按优先级与类型排序。

## UI 组件

### `IncrementalReadingSessionRenderer`
块渲染器入口，负责加载队列并渲染会话 UI。

### `IncrementalReadingSessionDemo`
阅读面板主体，提供：

- 原生块编辑器（`orca.components.Block`）
- 面包屑导航
- 操作区（标记已读、跳过、生成卡片、删除）
- 优先级滑块（实时更新）

### `IncrementalReadingBreadcrumb`
向上查找最近的 Topic，显示格式：

```
Topic Title > Extract Title
```

点击可跳转到对应块，Shift+点击在侧面板打开。

## 管理面板

管理面板用于全局查看渐进阅读卡片的统计与排期，并支持批量操作。

### 入口

- 命令：`orca-srs.openIRManager`（在当前面板打开管理面板）

### 统计面板

- 总卡片数
- 新卡数
- 到期卡数（已逾期 + 今天，红色/橙色大字号）
- 未来 7 天到期数（黄色高亮）

### 排期分组（视觉优先级从高到低）

分组顺序：

1. 已逾期（红色边框 + 红色标签，默认展开）
2. 今天（橙色边框 + 橙色标签，默认展开）
3. 明天（黄色高亮）
4. 未来7天（正常显示）
5. 新卡（蓝色标签）
6. 7天后（灰色文字，默认折叠）

分组边界使用自然日 00:00 作为基准。

### 侧面板跳转

- 点击卡片标题始终在侧面板打开对应块，主面板不变
- 支持在主面板继续工作，同时在侧面板查看与编辑卡片

### 批量操作

- 支持多选卡片
- 批量调整优先级（1-10）
- 操作完成后自动刷新列表
- 部分失败会提示数量与详情入口

### 迁移说明

无迁移，直接替换。

## 使用流程

1. 创建 Topic 块并标记 `#card`，`type=渐进阅读`
2. 在 Topic 下创建子块，自动标记为 `extracts`
3. 通过“渐进阅读”入口打开阅读面板
4. 在面板中阅读、编辑、标记已读或生成卡片

## 关键文件

- `src/srs/incrementalReadingStorage.ts`
- `src/srs/incrementalReadingScheduler.ts`
- `src/srs/incrementalReadingCollector.ts`
- `src/srs/incrementalReadingManagerUtils.ts`
- `src/components/IncrementalReadingSessionRenderer.tsx`
- `src/components/IncrementalReadingSessionDemo.tsx`
- `src/components/IncrementalReadingBreadcrumb.tsx`
- `src/components/IncrementalReadingManagerPanel.tsx`
- `src/components/IRStatistics.tsx`
- `src/components/IRCardList.tsx`
- `src/components/IRBulkActionBar.tsx`
